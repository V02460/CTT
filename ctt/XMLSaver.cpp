#include "XMLSaver.h"

#include "IOException.h"

namespace controller {
namespace project {

using ::exception::IOException;
using ::exception::IllegalArgumentException;
using ::model::saveable::Saveable;
using ::model::saveable::Memento;
using ::model::saveable::SaveableList;
using ::view::ViewState;

XMLSaver::XMLSaver() : pointerList() {}

const QString XMLSaver::SPACE         = "                            ";
const QString XMLSaver::DO_NOT_CHANGE = "   Do not edit this file!   ";

const QString XMLSaver::PROJECT = "project";
const QString XMLSaver::ELEMENT = "element";
const QString XMLSaver::VARIABLE = "variable";
const QString XMLSaver::POINTER = "pointer";
const QString XMLSaver::CLASS = "class";
const QString XMLSaver::ID = "id";
const QString XMLSaver::TYPE = "type";
const QString XMLSaver::TEMPLATE_TYPE = "template";
const QString XMLSaver::NAME = "name";
const QString XMLSaver::VALUE = "value";
const QString XMLSaver::VIEW = "view";
const QString XMLSaver::STATE = "state";

const QMap<XMLSaver::BaseSaveableType, QString> XMLSaver::initBEN() {
	QMap<BaseSaveableType, QString> map;
	map.insert(XMLSaver::BaseVideoList, "BaseVideoList");
	map.insert(XMLSaver::VideoList1, "VideoList1");
	map.insert(XMLSaver::VideoList2, "VideoList2");
	map.insert(XMLSaver::PlayerList1, "PlayerList1");
	map.insert(XMLSaver::Player2, "Player2");
	map.insert(XMLSaver::DiffList, "DiffList");
	return map;
}

const QMap<XMLSaver::BaseSaveableType, QString> XMLSaver::BASE_ELEMENT_NAMES = initBEN();

void XMLSaver::save(QString path) {
	initDocument(path);
	mapBasePointer();
	writeBaseElements();
	writeElements();
	endDocument();
}

XMLSaver::BaseSaveableType XMLSaver::stringToBaseSaveableType(QString string) {
	for each (BaseSaveableType type in BASE_ELEMENT_NAMES.keys()) {
		if (BASE_ELEMENT_NAMES.value(type) == string) {
			return type;
		}
	}
	throw IllegalArgumentException(string + " is not a base saveable type.");
}

void XMLSaver::initDocument(QString path) {
	file = new QFile(path);
	if (!file->open(QIODevice::WriteOnly)) {
		throw IOException("File " + path + " could not be opened.");
	}
	out = new QXmlStreamWriter(file);
	out->setAutoFormatting(true);
	out->writeStartDocument();
	out->writeComment(SPACE);
	out->writeComment(DO_NOT_CHANGE);
	out->writeComment(SPACE);
	out->writeStartElement(PROJECT);
}

void XMLSaver::mapBasePointer() {
	Project *project = Project::getInstance();
	pointerList.append(project->getBaseVideoList());
	pointerList.append(project->getVideoList1());
	pointerList.append(project->getVideoList2());
	pointerList.append(project->getPlayerList1());
	pointerList.append(project->getPlayer2());
	pointerList.append(project->getDiffList());
}

void XMLSaver::writeBaseElements() {
	int length = pointerList.length();
	for (elementID = 0; elementID < length; elementID++) {
		out->writeStartElement(ELEMENT);
		Saveable::sptr element = pointerList[elementID];
		Saveable::SaveableType type = element->saveableType();
		out->writeAttribute(CLASS, Saveable::SAVEABLE_TYPE_STRINGS[type]);
		if (type == Saveable::SaveableType::saveableList) {
			SaveableList<Saveable>::sptr list = element.staticCast<SaveableList<Saveable>>();
			out->writeAttribute(TEMPLATE_TYPE, Saveable::SAVEABLE_TYPE_STRINGS[list->getTemplateType()]);
		}
		out->writeAttribute(ID, QString::number(elementID));
		out->writeAttribute(TYPE, BASE_ELEMENT_NAMES.value(static_cast<BaseSaveableType>(elementID)));
		writeMemento(element->getMemento());
		out->writeEndElement();
	}
}

void XMLSaver::writeMemento(Memento memento) {
	QMap<QString, QString> variableMap = memento.getVariableMap();
	for (int i = 0; i < variableMap.size(); i++) {
		out->writeEmptyElement(VARIABLE);
		out->writeAttribute(NAME, variableMap.keys()[i]);
		out->writeAttribute(VALUE, variableMap.values()[i]);
	}
	QMap<QString, Saveable::sptr> pointerMap = memento.getPointerMap();
	for (int i = 0; i < pointerMap.size(); i++) {
		out->writeEmptyElement(POINTER);
		out->writeAttribute(NAME, pointerMap.keys()[i]);
		Saveable::sptr pointer = pointerMap.values()[i];
		bool newPointer = true;
		for (int i = 0; i < pointerList.length(); i++) {
			if (pointer == pointerList[i]) {
				out->writeAttribute(ID, QString::number(i));
				newPointer = false;
			}
		}
		if (newPointer) {
			out->writeAttribute(ID, QString::number(pointerList.length()));
			pointerList.append(pointer);
		}
	}
}

void XMLSaver::writeElements() {
	for (; elementID < pointerList.length(); elementID++) {
		out->writeStartElement(ELEMENT);
		Saveable::sptr element = pointerList[elementID];
		Saveable::SaveableType type = element->saveableType();
		out->writeAttribute(CLASS, Saveable::SAVEABLE_TYPE_STRINGS[type]);
		if (type == Saveable::SaveableType::saveableList) {
			SaveableList<Saveable>::sptr list = element.staticCast<SaveableList<Saveable>>();
			out->writeAttribute(TEMPLATE_TYPE, Saveable::SAVEABLE_TYPE_STRINGS[list->getTemplateType()]);
		}
		out->writeAttribute(ID, QString::number(elementID));
		writeMemento(element->getMemento());
		out->writeEndElement();
	}
}

XMLSaver *XMLSaver::getInstance() {
	if (instance.isNull()) {
		instance.reset(new XMLSaver());
	}
	return instance.data();
}

void XMLSaver::endDocument() {
	out->writeEmptyElement(VIEW);
	out->writeAttribute(STATE, QString::number(ViewState::getInstance()->getCurrentViewType()));
	out->writeEndElement();
	out->writeEndDocument();
	file->close();
}

XMLSaver::uptr XMLSaver::instance;

}  // namespace project
}  // namespace controller